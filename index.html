<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cliente Web Socket.IO</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 20px auto; }
    button { margin: 4px 0; }
    #log { border: 1px solid #ccc; padding: 8px; height: 200px; overflow-y: auto; font-size: 0.9rem; background: #f9f9f9; }
    input[type="text"] { width: 100%; padding: 4px; margin: 4px 0; box-sizing: border-box; }
  </style>
</head>
<body>
  <h1>Cliente Web – Control</h1>

  <button id="btnConnect">Conectar</button>
  <button id="btnDisconnect" disabled>Desconectar</button>

  <h3>Enviar mensaje</h3>
  <input type="text" id="msgInput" placeholder="Escribe un mensaje JSON o texto..." />
  <button id="btnSend" disabled>Enviar</button>

  <h3>Log</h3>
  <div id="log"></div>

  <script>
    let socket = null;
    const MY_NAME = "WebClient-01";  // nombre que verá el backend

    const btnConnect = document.getElementById("btnConnect");
    const btnDisconnect = document.getElementById("btnDisconnect");
    const btnSend = document.getElementById("btnSend");
    const msgInput = document.getElementById("msgInput");
    const logDiv = document.getElementById("log");

    function log(msg) {
      const time = new Date().toISOString().split("T")[1].split(".")[0];
      logDiv.innerText += "[" + time + "] " + msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setConnectedState(connected) {
      btnConnect.disabled = connected;
      btnDisconnect.disabled = !connected;
      btnSend.disabled = !connected;
    }

    btnConnect.addEventListener("click", () => {
      if (socket && socket.connected) {
        log("Ya está conectado.");
        return;
      }

      // Si el backend está en la misma URL:
      // const url = undefined; // io() usa origen actual
      // Si está en otro host/puerto:
      // const url = "http://192.168.0.10:5000";
      const url = undefined;

      log("Conectando...");
      socket = io(url);

      socket.on("connect", () => {
        log("Conectado al backend, registrando...");
        setConnectedState(true);
        socket.emit("register", { name: MY_NAME });
      });

      socket.on("registered", (data) => {
        log("Registro confirmado: " + JSON.stringify(data));
      });

      socket.on("disconnect", () => {
        log("Desconectado del backend.");
        setConnectedState(false);
      });

      socket.on("command", (data) => {
        log("Comando recibido: " + JSON.stringify(data));
        // Ejemplo: responder algo al backend
        socket.emit("device_message", {
          from: MY_NAME,
          type: "ack",
          received: data
        });
      });

      socket.on("error", (err) => {
        log("Error recibido: " + JSON.stringify(err));
      });

      // Por si quieres ver todos los eventos genéricos:
      socket.onAny((event, ...args) => {
        if (event !== "command" && event !== "registered") {
          log("Evento '" + event + "': " + JSON.stringify(args));
        }
      });
    });

    btnDisconnect.addEventListener("click", () => {
      if (socket) {
        log("Forzando desconexión...");
        socket.disconnect();
        setConnectedState(false);
      }
    });

    btnSend.addEventListener("click", () => {
      if (!socket || !socket.connected) {
        log("No hay conexión.");
        return;
      }
      const text = msgInput.value.trim();
      if (!text) return;

      let payload;
      try {
        // Si el usuario mete JSON válido, se envía como tal
        payload = JSON.parse(text);
      } catch (_) {
        // Si no es JSON, lo mandamos como campo "text"
        payload = { from: MY_NAME, type: "message", text };
      }

      socket.emit("device_message", payload);
      log("Enviado: " + JSON.stringify(payload));
      msgInput.value = "";
    });
  </script>
</body>
</html>
